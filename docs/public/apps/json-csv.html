<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Utility Hub – Resilient</title>
        <style>
            :root {
                --bg: #0b1020;
                --bg2: #0e1631;
                --card: #121938;
                --muted: #9fb3c8;
                --text: #e6eef7;
                --accent: #7cc6ff;
                --accent2: #9bffb0;
                --line: #1b2347;
            }
            * {
                box-sizing: border-box;
            }
            body {
                margin: 0;
                background: linear-gradient(
                    120deg,
                    #0b1020,
                    #0d1328 60%,
                    #0b1020
                );
                color: var(--text);
                font:
                    14px/1.45 system-ui,
                    Segoe UI,
                    Roboto,
                    Arial,
                    sans-serif;
            }
            .wrap {
                max-width: 1100px;
                margin: 32px auto;
                padding: 0 16px;
            }
            .app {
                background: var(--card);
                border: 1px solid var(--line);
                border-radius: 18px;
                box-shadow: 0 14px 40px rgba(0, 0, 0, 0.35);
                overflow: hidden;
            }
            header {
                display: flex;
                align-items: center;
                gap: 12px;
                padding: 16px 18px;
                border-bottom: 1px solid var(--line);
            }
            header h1 {
                font-size: 18px;
                margin: 0;
            }
            header small {
                color: var(--muted);
            }
            .tabs {
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
                padding: 12px;
                background: #0f1740;
                border-bottom: 1px solid var(--line);
                overflow: auto;
            }
            .tab {
                appearance: none;
                border: 1px solid #27356e;
                background: #17224a;
                color: #cfe0ff;
                border-radius: 12px;
                padding: 8px 12px;
                font-weight: 600;
                cursor: pointer;
                white-space: nowrap;
            }
            .tab.active {
                background: linear-gradient(180deg, #5fb7ff, #3aa5ff);
                color: #001428;
                border-color: transparent;
            }
            .panels {
                padding: 18px;
            }
            .panel {
                display: none;
            }
            .panel.active {
                display: block;
            }
            .grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 12px;
            }
            @media (max-width: 900px) {
                .grid {
                    grid-template-columns: 1fr;
                }
            }
            label {
                display: block;
                font-weight: 600;
                margin-bottom: 6px;
            }
            input[type="text"],
            input[type="number"],
            select,
            textarea {
                width: 100%;
                background: #0e1430;
                border: 1px solid #263065;
                border-radius: 12px;
                color: var(--text);
                padding: 10px 12px;
            }
            textarea {
                min-height: 140px;
                resize: vertical;
            }
            .btns {
                display: flex;
                gap: 10px;
                flex-wrap: wrap;
                margin-top: 10px;
            }
            button {
                appearance: none;
                border: 0;
                border-radius: 12px;
                padding: 10px 14px;
                font-weight: 700;
                cursor: pointer;
            }
            .primary {
                background: linear-gradient(180deg, #5fb7ff, #3aa5ff);
                color: #001428;
            }
            .secondary {
                background: #19224a;
                color: var(--text);
                border: 1px solid #27356e;
            }
            .success {
                background: linear-gradient(180deg, #9bffb0, #69f08f);
                color: #03200f;
            }
            .status {
                margin-top: 8px;
                color: #9fb3c8;
            }
            .card {
                border: 1px solid var(--line);
                border-radius: 14px;
                padding: 14px;
                background: #0f1740;
            }
            .row {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 12px;
            }
            @media (max-width: 900px) {
                .row {
                    grid-template-columns: 1fr;
                }
            }
            .tableWrap {
                overflow: auto;
                border: 1px solid var(--line);
                border-radius: 12px;
                margin-top: 12px;
            }
            table {
                border-collapse: collapse;
                width: 100%;
                min-width: 900px;
            }
            th,
            td {
                border-bottom: 1px solid var(--line);
                padding: 8px 10px;
                text-align: left;
            }
            th {
                position: sticky;
                top: 0;
                background: #0f1740;
            }
            .errorBox {
                background: #2a0f18;
                color: #ff9bb0;
                border: 1px solid #6a2840;
                padding: 8px 12px;
                border-radius: 10px;
                margin: 10px 18px;
            }
            code {
                background: #0f1540;
                border: 1px solid #22306b;
                border-radius: 8px;
                padding: 1px 6px;
            }
        </style>
    </head>
    <body>
        <div class="wrap">
            <div class="app">
                <header>
                    <svg
                        width="22"
                        height="22"
                        viewBox="0 0 24 24"
                        fill="none"
                        xmlns="http://www.w3.org/2000/svg"
                    >
                        <path
                            d="M4 4h7v7H4V4Z"
                            stroke="#7cc6ff"
                            stroke-width="1.5"
                        />
                        <path
                            d="M13 4h7v7h-7V4Z"
                            stroke="#7cc6ff"
                            stroke-width="1.5"
                        />
                        <path
                            d="M4 13h7v7H4v-7Z"
                            stroke="#7cc6ff"
                            stroke-width="1.5"
                        />
                        <path
                            d="M13 13h7v7h-7v-7Z"
                            stroke="#7cc6ff"
                            stroke-width="1.5"
                        />
                    </svg>
                    <h1>Utility Hub</h1>
                    <small>Resilient build • client‑side only</small>
                </header>
                <nav class="tabs" id="tabs"></nav>
                <div id="err" class="errorBox" style="display: none"></div>
                <div class="panels" id="panels"></div>
            </div>
        </div>

        <script>
            // Polyfills for older browsers
            if (!String.prototype.replaceAll) {
                String.prototype.replaceAll = function (s, r) {
                    return this.split(s).join(r);
                };
            }

            // Shared helpers (declared FIRST to avoid hoist pitfalls)
            function escapeHtml(s) {
                return String(s).replace(
                    /[&<>"']/g,
                    (c) =>
                        ({
                            "&": "&amp;",
                            "<": "&lt;",
                            ">": "&gt;",
                            '"': "&quot;",
                            "'": "&#39;",
                        })[c],
                );
            }
            function saveBlob(blob, name) {
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = name;
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);
            }
            function readPath(obj, path) {
                const parts = path.split(".").filter(Boolean);
                let cur = obj;
                for (const p of parts) {
                    if (cur == null) return undefined;
                    cur = cur[p];
                }
                return cur;
            }
            function autoPickArray(obj) {
                const q = [obj];
                let best = null,
                    bestLen = 0;
                while (q.length) {
                    const x = q.shift();
                    if (Array.isArray(x)) {
                        const len = x.length;
                        const isObj =
                            len > 0 &&
                            typeof x[0] === "object" &&
                            !Array.isArray(x[0]);
                        if (isObj && len > bestLen) {
                            best = x;
                            bestLen = len;
                        }
                        for (const it of x) {
                            if (it && typeof it === "object") q.push(it);
                        }
                    } else if (x && typeof x === "object") {
                        for (const k in x) {
                            if (Object.prototype.hasOwnProperty.call(x, k))
                                q.push(x[k]);
                        }
                    }
                }
                if (!best) throw new Error("Tidak menemukan array of objects.");
                return best;
            }
            function flattenObj(o, prefix = "") {
                const out = {};
                for (const [k, v] of Object.entries(o)) {
                    const key = prefix ? `${prefix}.${k}` : k;
                    if (v && typeof v === "object" && !Array.isArray(v))
                        Object.assign(out, flattenObj(v, key));
                    else out[key] = v;
                }
                return out;
            }
            function valueToString(v) {
                if (v == null) return "";
                if (typeof v === "object") return JSON.stringify(v);
                return String(v);
            }
            function toCSV(
                headers,
                rows,
                { delimiter = ",", quoteAll = true },
            ) {
                const enc = (s) => {
                    const needsQuote =
                        quoteAll ||
                        s.includes('"') ||
                        s.includes("\n") ||
                        s.includes("\r") ||
                        s.includes(delimiter);
                    let x = s.replaceAll('"', '""');
                    return needsQuote ? `"${x}"` : x;
                };
                const head = headers.map(enc).join(delimiter);
                const body = rows
                    .map((r) => r.map(enc).join(delimiter))
                    .join("\n");
                return head + "\n" + body + "\n";
            }
            function parseCSV(text, delim = ",") {
                const rows = [];
                let i = 0,
                    field = "",
                    row = [],
                    inQ = false;
                const pf = () => {
                    row.push(field);
                    field = "";
                };
                const pr = () => {
                    rows.push(row);
                    row = [];
                };
                for (; i < text.length; i++) {
                    const c = text[i];
                    if (inQ) {
                        if (c === '"') {
                            if (text[i + 1] === '"') {
                                field += '"';
                                i++;
                            } else {
                                inQ = false;
                            }
                        } else {
                            field += c;
                        }
                        continue;
                    }
                    if (c === '"') {
                        inQ = true;
                        continue;
                    }
                    if (c === delim) {
                        pf();
                        continue;
                    }
                    if (c === "\n") {
                        pf();
                        pr();
                        continue;
                    }
                    if (c === "\r") {
                        continue;
                    }
                    field += c;
                }
                pf();
                if (row.length > 1 || rows.length === 0) pr();
                const headers = (rows.shift() || []).map((h) => h.trim());
                return { headers, rows };
            }
            function renderGrid(scope, headers, rows) {
                scope.grid.style.display = "block";
                scope.thead.innerHTML = `<tr>${headers.map((h) => `<th>${escapeHtml(h)}</th>`).join("")}</tr>`;
                scope.tbody.innerHTML = rows
                    .map(
                        (r) =>
                            `<tr>${r.map((v) => `<td>${escapeHtml(String(v))}</td>`).join("")}</tr>`,
                    )
                    .join("");
            }

            // Feature blocks
            function renderJsonCsv(root) {
                root.innerHTML = `
  <div class="card">
    <div class="row">
      <div><label>Upload JSON</label><input type="file" id="jc_file" accept="application/json,.json" /><div class="status">Atau paste JSON di kanan.</div></div>
      <div><label>Paste JSON</label><textarea id="jc_text" placeholder='{"object":{"data":[{"id":1,"name":"A"}]}}'></textarea></div>
    </div>
    <div class="row" style="margin-top:10px">
      <div><label>Array path (dot)</label><input id="jc_path" type="text" value="object.data" /><div class="status">Contoh: <code>object.data</code> atau kosongkan untuk auto‑detect.</div></div>
      <div><label>Delimiter</label><select id="jc_delim"><option value="," selected>Comma (,)</option><option value=";">Semicolon (;)</option><option value="\t">Tab (\t)</option></select></div>
    </div>
    <div class="btns"><label class="secondary" style="padding:6px 10px;border-radius:10px"><input id="jc_quote" type="checkbox" checked /> Quote all</label><label class="secondary" style="padding:6px 10px;border-radius:10px"><input id="jc_bom" type="checkbox" checked /> UTF‑8 BOM</label><label class="secondary" style="padding:6px 10px;border-radius:10px"><input id="jc_flat" type="checkbox" checked /> Flatten nested</label></div>
    <label>Preferred column order (opsional)</label><input id="jc_pref" type="text" />
    <label style="margin-top:8px">Rename headers (CSV: old:new)</label><textarea id="jc_rename" placeholder="id:ID, nmKomponen:Nama Komponen"></textarea>
    <div class="btns"><button class="primary" id="jc_preview">Preview</button><button class="success" id="jc_download">Download CSV</button></div>
    <div id="jc_status" class="status"></div>
    <div id="jc_grid" class="tableWrap" style="display:none"><table><thead id="jc_thead"></thead><tbody id="jc_tbody"></tbody></table></div>
  </div>
`;
                const $ = (sel) => root.querySelector(sel);
                const jc = {
                    file: $("#jc_file"),
                    text: $("#jc_text"),
                    path: $("#jc_path"),
                    delim: $("#jc_delim"),
                    quote: $("#jc_quote"),
                    bom: $("#jc_bom"),
                    flat: $("#jc_flat"),
                    pref: $("#jc_pref"),
                    rename: $("#jc_rename"),
                    preview: $("#jc_preview"),
                    download: $("#jc_download"),
                    status: $("#jc_status"),
                    grid: $("#jc_grid"),
                    thead: $("#jc_thead"),
                    tbody: $("#jc_tbody"),
                };
                jc.file.addEventListener("change", async (e) => {
                    const f = e.target.files?.[0];
                    if (!f) return;
                    jc.text.value = await f.text();
                    jc.status.innerHTML = `Loaded <b>${escapeHtml(f.name)}</b>`;
                });
                jc.preview.addEventListener("click", () => {
                    try {
                        const { headers, rows } = jsonToCsvProcess(jc);
                        renderGrid(jc, headers, rows.slice(0, 50));
                        jc.status.textContent = `Preview ${Math.min(50, rows.length)} of ${rows.length} rows`;
                    } catch (err) {
                        jc.status.innerHTML = `<span style="color:#ff9bb0">${escapeHtml(err.message)}</span>`;
                    }
                });
                jc.download.addEventListener("click", () => {
                    try {
                        const { headers, rows } = jsonToCsvProcess(jc);
                        const csv = toCSV(headers, rows, {
                            delimiter: jc.delim.value,
                            quoteAll: jc.quote.checked,
                        });
                        const blob = new Blob(
                            [jc.bom.checked ? "\uFEFF" : "", csv],
                            { type: "text/csv;charset=utf-8;" },
                        );
                        saveBlob(blob, `json_to_csv_${Date.now()}.csv`);
                        jc.status.textContent = `CSV generated: ${rows.length} rows / ${headers.length} cols`;
                    } catch (err) {
                        jc.status.innerHTML = `<span style="color:#ff9bb0">${escapeHtml(err.message)}</span>`;
                    }
                });
                function jsonToCsvProcess(jc) {
                    const txt = jc.text.value.trim();
                    if (!txt) throw new Error("JSON kosong.");
                    let data;
                    try {
                        data = JSON.parse(txt);
                    } catch (e) {
                        throw new Error("JSON tidak valid: " + e.message);
                    }
                    const path = jc.path.value.trim();
                    let arr = path ? readPath(data, path) : autoPickArray(data);
                    if (!Array.isArray(arr))
                        throw new Error("Path tidak mengarah ke array.");
                    if (arr.length === 0) throw new Error("Array kosong.");
                    const rows = jc.flat.checked
                        ? arr.map((o) => flattenObj(o))
                        : arr.slice();
                    const headerSet = new Set();
                    rows.forEach((r) =>
                        Object.keys(r).forEach((k) => headerSet.add(k)),
                    );
                    let headers = Array.from(headerSet);
                    const pref = jc.pref.value
                        .split(",")
                        .map((s) => s.trim())
                        .filter(Boolean);
                    if (pref.length) {
                        headers = [
                            ...pref.filter((h) => headerSet.has(h)),
                            ...headers.filter((h) => !pref.includes(h)),
                        ];
                    }
                    const renamePairs = (jc.rename.value || "")
                        .split(",")
                        .map((s) => s.trim())
                        .filter(Boolean)
                        .map((p) => {
                            const [a, b] = p.split(":").map((x) => x?.trim());
                            return a && b ? [a, b] : null;
                        })
                        .filter(Boolean);
                    const renameDict = Object.fromEntries(renamePairs);
                    const finalHeaders = headers.map((h) => renameDict[h] ?? h);
                    const aligned = rows.map((r) =>
                        headers.map((h) => valueToString(r[h])),
                    );
                    return { headers: finalHeaders, rows: aligned };
                }
            }

            function renderJsonTools(root) {
                root.innerHTML = `
  <div class="grid">
    <div class="card"><div class="status">JSON Formatter / Validator</div><textarea id="jt_in" placeholder='{"a":1,"b":[2,3]}'></textarea><div class="btns"><button class="primary" id="jt_beautify">Beautify</button><button class="secondary" id="jt_minify">Minify</button><button class="secondary" id="jt_clear">Clear</button></div><div id="jt_status" class="status"></div></div>
    <div class="card"><div class="status">Base64 ⇆ Text</div><label>Text</label><textarea id="b64_text"></textarea><label style="margin-top:8px">Base64</label><textarea id="b64_base"></textarea><div class="btns"><button class="primary" id="b64_enc">Encode →</button><button class="secondary" id="b64_dec">← Decode</button><button class="secondary" id="b64_clear">Clear</button></div></div>
  </div>
`;
                const $ = (sel) => root.querySelector(sel);
                $("#jt_beautify").addEventListener("click", () => {
                    const ta = $("#jt_in");
                    try {
                        ta.value = JSON.stringify(
                            JSON.parse(ta.value),
                            null,
                            2,
                        );
                        $("#jt_status").textContent = "OK";
                    } catch (e) {
                        $("#jt_status").textContent = "Error: " + e.message;
                    }
                });
                $("#jt_minify").addEventListener("click", () => {
                    const ta = $("#jt_in");
                    try {
                        ta.value = JSON.stringify(JSON.parse(ta.value));
                        $("#jt_status").textContent = "OK";
                    } catch (e) {
                        $("#jt_status").textContent = "Error: " + e.message;
                    }
                });
                $("#jt_clear").addEventListener("click", () => {
                    $("#jt_in").value = "";
                    $("#jt_status").textContent = "";
                });
                $("#b64_enc").addEventListener("click", () => {
                    const t = $("#b64_text").value;
                    $("#b64_base").value = btoa(
                        unescape(encodeURIComponent(t)),
                    );
                });
                $("#b64_dec").addEventListener("click", () => {
                    try {
                        const b = $("#b64_base").value;
                        $("#b64_text").value = decodeURIComponent(
                            escape(atob(b)),
                        );
                    } catch (e) {
                        alert("Base64 tidak valid");
                    }
                });
                $("#b64_clear").addEventListener("click", () => {
                    $("#b64_text").value = "";
                    $("#b64_base").value = "";
                });
            }

            function renderTextTools(root) {
                root.innerHTML = `
  <div class="grid">
    <div class="card"><div class="status">Case Converter</div><textarea id="tt_text" placeholder="Ketik teks di sini..."></textarea><div class="btns"><button class="primary" id="tt_upper">UPPERCASE</button><button class="secondary" id="tt_lower">lowercase</button><button class="secondary" id="tt_title">Title Case</button><button class="secondary" id="tt_snake">snake_case</button><button class="secondary" id="tt_camel">camelCase</button></div></div>
    <div class="card"><div class="status">Word / Character Counter</div><textarea id="wc_text" placeholder="Tulis teks..."></textarea><div id="wc_out" class="status">Words: 0 • Chars: 0</div></div>
  </div>
`;
                const $ = (sel) => root.querySelector(sel);
                $("#tt_upper").addEventListener(
                    "click",
                    () =>
                        ($("#tt_text").value =
                            $("#tt_text").value.toUpperCase()),
                );
                $("#tt_lower").addEventListener(
                    "click",
                    () =>
                        ($("#tt_text").value =
                            $("#tt_text").value.toLowerCase()),
                );
                $("#tt_title").addEventListener(
                    "click",
                    () =>
                        ($("#tt_text").value = $("#tt_text").value.replace(
                            /\w\S*/g,
                            (w) =>
                                w[0].toUpperCase() + w.slice(1).toLowerCase(),
                        )),
                );
                $("#tt_snake").addEventListener(
                    "click",
                    () =>
                        ($("#tt_text").value = $("#tt_text")
                            .value.trim()
                            .replace(/[^A-Za-z0-9]+/g, "_")
                            .replace(/^_+|_+$/g, "")
                            .toLowerCase()),
                );
                $("#tt_camel").addEventListener(
                    "click",
                    () =>
                        ($("#tt_text").value = $("#tt_text")
                            .value.toLowerCase()
                            .replace(/[^a-z0-9]+(.)/g, (m, chr) =>
                                chr.toUpperCase(),
                            )),
                );
                const wc = () => {
                    const t = $("#wc_text").value;
                    $("#wc_out").textContent =
                        `Words: ${(t.match(/\S+/g) || []).length} • Chars: ${t.length}`;
                };
                $("#wc_text").addEventListener("input", wc);
            }

            function renderDevTools(root) {
                root.innerHTML = `
  <div class="grid">
    <div class="card"><div class="status">UUID v4 Generator</div><div class="btns"><button class="primary" id="ud_gen">Generate</button><button class="secondary" id="ud_many">×10</button></div><textarea id="ud_out" placeholder="UUIDs..." style="margin-top:8px"></textarea></div>
    <div class="card"><div class="status">JWT Decoder</div><textarea id="jwt_in" placeholder="paste JWT..."></textarea><div class="btns"><button class="primary" id="jwt_dec">Decode</button><button class="secondary" id="jwt_clear">Clear</button></div><label>Header</label><textarea id="jwt_head" readonly></textarea><label>Payload</label><textarea id="jwt_body" readonly></textarea></div>
  </div>
`;
                const $ = (sel) => root.querySelector(sel);
                const gen = () => {
                    const a = crypto.getRandomValues(new Uint8Array(16));
                    a[6] = (a[6] & 0x0f) | 0x40;
                    a[8] = (a[8] & 0x3f) | 0x80;
                    const h = [...a]
                        .map((b) => (b + 256).toString(16).slice(1))
                        .join("");
                    return `${h.slice(0, 8)}-${h.slice(8, 12)}-${h.slice(12, 16)}-${h.slice(16, 20)}-${h.slice(20)}`;
                };
                $("#ud_gen").addEventListener(
                    "click",
                    () => ($("#ud_out").value = gen()),
                );
                $("#ud_many").addEventListener(
                    "click",
                    () =>
                        ($("#ud_out").value = Array.from(
                            { length: 10 },
                            gen,
                        ).join("\n")),
                );
                const b64url = (s) => {
                    s = s.replace(/-/g, "+").replace(/_/g, "/");
                    const pad = s.length % 4;
                    if (pad) s += "=".repeat(4 - pad);
                    return s;
                };
                const pretty = (o) => {
                    try {
                        return JSON.stringify(JSON.parse(o), null, 2);
                    } catch {
                        return o;
                    }
                };
                $("#jwt_dec").addEventListener("click", () => {
                    try {
                        const [h, p] = $("#jwt_in").value.split(".");
                        $("#jwt_head").value = pretty(atob(b64url(h)));
                        $("#jwt_body").value = pretty(atob(b64url(p)));
                    } catch (e) {
                        alert("JWT tidak valid");
                    }
                });
                $("#jwt_clear").addEventListener("click", () => {
                    $("#jwt_in").value = "";
                    $("#jwt_head").value = "";
                    $("#jwt_body").value = "";
                });
            }

            function renderSecurity(root) {
                root.innerHTML = `
  <div class="grid">
    <div class="card"><div class="status">Password Generator</div><div class="row"><div><label>Panjang</label><input id="pw_len" type="number" min="6" max="128" value="16" /></div><div><label>Opsi</label><div class="btns" style="margin:0"><label class="secondary" style="padding:6px 10px;border-radius:10px"><input id="pw_upper" type="checkbox" checked /> A‑Z</label><label class="secondary" style="padding:6px 10px;border-radius:10px"><input id="pw_lower" type="checkbox" checked /> a‑z</label><label class="secondary" style="padding:6px 10px;border-radius:10px"><input id="pw_num" type="checkbox" checked /> 0‑9</label><label class="secondary" style="padding:6px 10px;border-radius:10px"><input id="pw_sym" type="checkbox" /> !@#$</label></div></div></div><div class="btns"><button class="primary" id="pw_make">Generate</button><button class="secondary" id="pw_copy">Copy</button></div><input id="pw_out" type="text" readonly style="margin-top:8px" /></div>
    <div class="card"><div class="status">Hash (SHA‑256)</div><textarea id="sha_in" placeholder="Teks..."></textarea><div class="btns"><button class="primary" id="sha_go">Hash</button><button class="secondary" id="sha_clear">Clear</button></div><input id="sha_out" type="text" readonly /></div>
  </div>
`;
                const $ = (sel) => root.querySelector(sel);
                $("#pw_make").addEventListener("click", () => {
                    const L = +$("#pw_len").value || 16;
                    const sets = [];
                    if ($("#pw_upper").checked)
                        sets.push("ABCDEFGHIJKLMNOPQRSTUVWXYZ");
                    if ($("#pw_lower").checked)
                        sets.push("abcdefghijklmnopqrstuvwxyz");
                    if ($("#pw_num").checked) sets.push("0123456789");
                    if ($("#pw_sym").checked)
                        sets.push("!@#$%^&*()-_=+[]{};:,.<>?/");
                    if (!sets.length) return alert("Pilih minimal satu set");
                    const all = sets.join("");
                    const a = new Uint32Array(L);
                    crypto.getRandomValues(a);
                    let out = "";
                    for (let i = 0; i < L; i++) {
                        out += all[a[i] % all.length];
                    }
                    $("#pw_out").value = out;
                });
                $("#pw_copy").addEventListener("click", () => {
                    navigator.clipboard.writeText($("#pw_out").value || "");
                });
                $("#sha_go").addEventListener("click", async () => {
                    const t = new TextEncoder().encode($("#sha_in").value);
                    const buf = await crypto.subtle.digest("SHA-256", t);
                    const hex = [...new Uint8Array(buf)]
                        .map((b) => b.toString(16).padStart(2, "0"))
                        .join("");
                    $("#sha_out").value = hex;
                });
                $("#sha_clear").addEventListener("click", () => {
                    $("#sha_in").value = "";
                    $("#sha_out").value = "";
                });
            }

            function renderMedia(root) {
                root.innerHTML = `
  <div class="card"><div class="status">Image Compressor</div><div class="row"><div><label>Upload image</label><input type="file" id="im_file" accept="image/*" /></div><div><label>Kualitas</label><input type="range" id="im_q" min="0.1" max="1" step="0.05" value="0.8" /></div></div><div class="btns"><button class="primary" id="im_preview">Preview</button><button class="success" id="im_download">Download</button></div><canvas id="im_canvas" style="max-width:100%;border:1px solid var(--line);border-radius:10px;background:#0e1430"></canvas><div id="im_status" class="status"></div></div>
`;
                const $ = (sel) => root.querySelector(sel);
                let img = null;
                $("#im_file").addEventListener("change", async (e) => {
                    const f = e.target.files?.[0];
                    if (!f) return;
                    const url = URL.createObjectURL(f);
                    img = new Image();
                    img.onload = () => {
                        URL.revokeObjectURL(url);
                        $("#im_status").textContent =
                            `Loaded ${f.name} (${(f.size / 1024).toFixed(1)} KB)`;
                    };
                    img.src = url;
                });
                const draw = (type) => {
                    if (!img) return alert("Upload image dulu");
                    const c = $("#im_canvas");
                    const q = parseFloat($("#im_q").value) || 0.8;
                    const w = img.width,
                        h = img.height;
                    c.width = w;
                    c.height = h;
                    const ctx = c.getContext("2d");
                    ctx.fillStyle = "#000";
                    ctx.fillRect(0, 0, w, h);
                    ctx.drawImage(img, 0, 0, w, h);
                    return new Promise((res) =>
                        c.toBlob((b) => res(b), type, q),
                    );
                };
                $("#im_preview").addEventListener("click", () =>
                    draw("image/jpeg").then((b) => {
                        $("#im_status").textContent =
                            `Preview ~ ${(b.size / 1024).toFixed(1)} KB @ quality ${$("#im_q").value}`;
                    }),
                );
                $("#im_download").addEventListener("click", () =>
                    draw("image/jpeg").then((b) => {
                        saveBlob(b, `compressed_${Date.now()}.jpg`);
                    }),
                );
            }

            function renderMisc(root) {
                root.innerHTML = `
  <div class="grid">
    <div class="card"><div class="status">Regex Tester</div><label>Pattern</label><input id="rx_pat" type="text" placeholder="e.g. ^[A-Z]+$" /><label style="margin-top:8px">Flags</label><input id="rx_flags" type="text" placeholder="g i m s u y" value="g" /><label style="margin-top:8px">Input</label><textarea id="rx_in" placeholder="Teks..."></textarea><div class="btns"><button class="primary" id="rx_run">Run</button><button class="secondary" id="rx_clear">Clear</button></div><label>Matches</label><textarea id="rx_out" readonly></textarea></div>
    <div class="card"><div class="status">Color Picker & Palette</div><input id="cp_color" type="color" value="#7cc6ff" /><div class="btns"><button class="primary" id="cp_gen">Generate palette</button></div><div id="cp_out" style="display:flex;gap:8px;flex-wrap:wrap"></div></div>
  </div>
`;
                const $ = (sel) => root.querySelector(sel);
                $("#rx_run").addEventListener("click", () => {
                    try {
                        const r = new RegExp(
                            $("#rx_pat").value,
                            $("#rx_flags").value,
                        );
                        const txt = $("#rx_in").value;
                        const m = [...txt.matchAll(r)].map((x) => x[0]);
                        $("#rx_out").value = m.length
                            ? m.join("\n")
                            : "(no match)";
                    } catch (e) {
                        alert("Regex tidak valid");
                    }
                });
                $("#rx_clear").addEventListener("click", () => {
                    $("#rx_pat").value = "";
                    $("#rx_flags").value = "";
                    $("#rx_in").value = "";
                    $("#rx_out").value = "";
                });
                $("#cp_gen").addEventListener("click", () => {
                    const c = $("#cp_color").value;
                    const shades = [-40, -20, 0, 20, 40].map((n) =>
                        shiftColor(c, n),
                    );
                    $("#cp_out").innerHTML = shades
                        .map(
                            (s) =>
                                `<div style="width:90px;height:36px;border-radius:10px;border:1px solid var(--line);background:${s};display:flex;align-items:center;justify-content:center">${s}</div>`,
                        )
                        .join("");
                });
                function shiftColor(hex, amt) {
                    hex = hex.replace("#", "");
                    if (hex.length === 3)
                        hex = hex
                            .split("")
                            .map((c) => c + c)
                            .join("");
                    let [r, g, b] = [
                        parseInt(hex.slice(0, 2), 16),
                        parseInt(hex.slice(2, 4), 16),
                        parseInt(hex.slice(4, 6), 16),
                    ];
                    const adj = (x) =>
                        Math.max(
                            0,
                            Math.min(255, x + Math.round((255 * amt) / 100)),
                        );
                    r = adj(r);
                    g = adj(g);
                    b = adj(b);
                    return (
                        "#" +
                        [r, g, b]
                            .map((x) => x.toString(16).padStart(2, "0"))
                            .join("")
                    );
                }
            }

            (function init() {
                const features = [
                    {
                        id: "data-json-csv",
                        label: "Data • JSON⇆CSV",
                        render: renderJsonCsv,
                    },
                    {
                        id: "data-json-tools",
                        label: "Data • JSON Tools",
                        render: renderJsonTools,
                    },
                    {
                        id: "text-tools",
                        label: "Text Tools",
                        render: renderTextTools,
                    },
                    {
                        id: "dev-tools",
                        label: "Dev Tools",
                        render: renderDevTools,
                    },
                    {
                        id: "security",
                        label: "Security",
                        render: renderSecurity,
                    },
                    { id: "media", label: "Media", render: renderMedia },
                    { id: "misc", label: "Misc", render: renderMisc },
                ];
                const tabsEl = document.getElementById("tabs");
                const panelsEl = document.getElementById("panels");
                const errBox = document.getElementById("err");

                // 1) Create all tabs/panels first
                features.forEach((f, i) => {
                    const b = document.createElement("button");
                    b.className = "tab" + (i === 0 ? " active" : "");
                    b.textContent = f.label;
                    b.dataset.id = f.id;
                    tabsEl.appendChild(b);
                    const p = document.createElement("div");
                    p.className = "panel" + (i === 0 ? " active" : "");
                    p.dataset.id = f.id;
                    panelsEl.appendChild(p);
                });

                // 2) Render each feature in try/catch so satu error tidak mematahkan yg lain
                features.forEach((f, i) => {
                    const p = panelsEl.querySelector(`[data-id="${f.id}"]`);
                    try {
                        f.render(p);
                    } catch (e) {
                        p.innerHTML = `<div class="errorBox">Gagal render <b>${escapeHtml(f.label)}</b>: ${escapeHtml(e.message)}</div>`;
                        errBox.style.display = "block";
                        errBox.innerHTML += `Gagal render ${escapeHtml(f.label)}: ${escapeHtml(e.message)}<br>`;
                    }
                });

                tabsEl.addEventListener("click", (e) => {
                    const btn = e.target.closest(".tab");
                    if (!btn) return;
                    const id = btn.dataset.id;
                    document
                        .querySelectorAll(".tab")
                        .forEach((x) =>
                            x.classList.toggle("active", x.dataset.id === id),
                        );
                    document
                        .querySelectorAll(".panel")
                        .forEach((x) =>
                            x.classList.toggle("active", x.dataset.id === id),
                        );
                });
            })();
        </script>
    </body>
</html>
